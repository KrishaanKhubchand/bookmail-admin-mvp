name: Hourly Email Scheduler

on:
  schedule:
    # Run every hour at minute 0 (UTC)
    - cron: '0 * * * *'
  workflow_dispatch: # Allows manual triggering for testing

env:
  SUPABASE_EDGE_FUNCTION_URL: 'https://gloqngqccjiqmowdzvhb.supabase.co/functions/v1/email-scheduler'

jobs:
  send-scheduled-emails:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Call Email Scheduler Edge Function
        id: scheduler
        run: |
          echo "ðŸ• Triggering email scheduler at $(date -u)"
          
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Email-Scheduler" \
            "$SUPABASE_EDGE_FUNCTION_URL")
          
          # Extract HTTP status code
          http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          # Check if request was successful
          if [ $http_code -eq 200 ]; then
            echo "âœ… Email scheduler completed successfully"
            echo "response_body=$body" >> $GITHUB_OUTPUT
          else
            echo "âŒ Email scheduler failed with HTTP $http_code"
            echo "Response: $body"
            exit 1
          fi

      - name: Parse and Log Results
        if: success()
        run: |
          echo "ðŸ“Š Scheduler Results:"
          echo '${{ steps.scheduler.outputs.response_body }}' | jq -r '
            "ðŸƒ Run ID: " + .run_id,
            "ðŸ‘¥ Eligible Users: " + (.total_eligible | tostring),
            "ðŸ“§ Emails Sent: " + (.sent | tostring),
            "âŒ Errors: " + (.errors | tostring),
            "âœ… Completed: " + (.completed | tostring),
            "ðŸ“­ No Content: " + (.no_content | tostring)
          '

      - name: Handle Failure
        if: failure()
        run: |
          echo "ðŸ’¥ Email scheduler failed!"
          echo "Check the logs above for details."
          echo "This could be due to:"
          echo "- Missing or invalid SUPABASE_SERVICE_ROLE_KEY secret"
          echo "- Supabase Edge Function issues"
          echo "- Network connectivity problems"

      - name: Create Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Email Scheduler Success**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“§ Check logs above for email count and details" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Email Scheduler Failed**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” Check the logs for error details" >> $GITHUB_STEP_SUMMARY
          fi
          echo "ðŸ• Execution time: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Next scheduled run: $(date -u -d '+1 hour')" >> $GITHUB_STEP_SUMMARY
